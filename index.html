<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Responsive Tetris with Device Choice</title>
<style>
  body {
    background:#111;
    color:white;
    font-family:Arial;
    display:flex;
    justify-content:center;
    gap:20px;
    flex-direction: column;
    align-items: center;
  }
  canvas {
    background:#000;
    border:2px solid #aaa;
    touch-action: none;
  }
  .side {
    display:flex;
    flex-direction: column;
    align-items:center;
  }
  .controls {
    display:flex;
    gap:10px;
    margin-top:10px;
  }
  #deviceSelect {
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
    margin-top:50px;
  }
  button {
    padding:10px 15px;
    font-size:16px;
  }
  #mobileControls {
    flex-direction: row;
    justify-content: center;
    margin-top:10px;
  }
</style>
</head>
<body>

<div id="deviceSelect">
  <h2>디바이스 선택</h2>
  <button id="pcBtn">컴퓨터</button>
  <button id="mobileBtn">스마트폰</button>
</div>

<div class="side" id="gameContainer" style="display:none;">
  <h3>HOLD</h3>
  <canvas id="hold" width="120" height="120"></canvas>
  <h3>NEXT</h3>
  <canvas id="next" width="120" height="120"></canvas>
  <h3>Score</h3>
  <div id="score">0</div>
  <h3>Level</h3>
  <div id="level">1</div>
</div>

<canvas id="game" style="display:none;"></canvas>

<!-- 모바일용 버튼 (화면 아래쪽) -->
<div id="buttonsContainer" style="display:none;">
  <div class="controls" id="mobileControls">
    <button id="holdBtnM">HOLD</button>
    <button id="rotateBtnM">ROTATE</button>
    <button id="dropBtnM">DROP</button>
  </div>
</div>

<script>
/* ===== 디바이스 선택 ===== */
let isMobile = false;
const deviceSelect = document.getElementById('deviceSelect');
const gameContainer = document.getElementById('gameContainer');
const canvas = document.getElementById('game');
const buttonsContainer = document.getElementById('buttonsContainer');
const mobileControls = document.getElementById('mobileControls');

document.getElementById('pcBtn').onclick = ()=>{
  isMobile=false;
  startGame();
};
document.getElementById('mobileBtn').onclick = ()=>{
  isMobile=true;
  startGame();
};

function startGame(){
  deviceSelect.style.display="none";
  gameContainer.style.display="flex";
  canvas.style.display="block";
  buttonsContainer.style.display = isMobile ? "flex" : "none";
  // 모바일이면 화면 아래로 이동
  if(isMobile) buttonsContainer.style.position = "fixed";
  if(isMobile) buttonsContainer.style.bottom = "10px";
  if(isMobile) buttonsContainer.style.left = "50%";
  if(isMobile) buttonsContainer.style.transform = "translateX(-50%)";
  mobileControls.style.display = isMobile ? "flex" : "none";
  initGame();
}

/* ===== 테트리스 기본 코드 ===== */
const ctx = canvas.getContext("2d");
const holdC=document.getElementById("hold").getContext("2d");
const nextC=document.getElementById("next").getContext("2d");
let BLOCK = 30;
let score=0, level=1, dropSpeed=30;

function resizeCanvas(){
  const width = Math.min(window.innerWidth*0.9, 300);
  BLOCK = width / 10;
  canvas.width = width;
  canvas.height = BLOCK*20;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

/* 사운드 */
const audio=new (window.AudioContext||window.webkitAudioContext)();
function sound(f){const o=audio.createOscillator();o.frequency.value=f;o.connect(audio.destination);o.start();o.stop(audio.currentTime+0.05);}

/* 블록 */
const SHAPES={
 I:[[1,1,1,1]],
 O:[[1,1],[1,1]],
 T:[[0,1,0],[1,1,1]],
 S:[[0,1,1],[1,1,0]],
 Z:[[1,1,0],[0,1,1]],
 J:[[1,0,0],[1,1,1]],
 L:[[0,0,1],[1,1,1]],
 P:[[1,1,0],[0,1,1],[0,1,0]]
};
const COLORS={I:"#0ff",O:"#ff0",T:"#a0f",S:"#0f0",Z:"#f00",J:"#00f",L:"#fa0",P:"#f0f"};

function newPiece(){
 const k=Object.keys(SHAPES)[Math.floor(Math.random()*8)];
 return {shape:SHAPES[k],color:COLORS[k],x:3,y:0};
}

/* 보드 */
let board, piece, next, hold, canHold;

function initGame(){
  board=Array.from({length:20},()=>Array(10).fill(0));
  piece=newPiece();
  next=newPiece();
  hold=null;
  canHold=true;
  count=0;
  update();
}

/* 충돌 */
function collide(p){
 for(let y=0;y<p.shape.length;y++)
  for(let x=0;x<p.shape[y].length;x++)
   if(p.shape[y][x]){
    let nx=p.x+x, ny=p.y+y;
    if(nx<0||nx>=10||ny>=20||board[ny]?.[nx]) return true;
   }
 return false;
}

/* 고정 */
function merge(){
 piece.shape.forEach((r,y)=>r.forEach((v,x)=>{if(v) board[piece.y+y][piece.x+x]=piece.color;}));
 sound(200);
 clearLines();
 piece=next;
 next=newPiece();
 canHold=true;
 if(collide(piece)){alert("GAME OVER"); location.reload();}
}

/* 줄 삭제 */
function clearLines(){
 let lines=0;
 board=board.filter(r=>{if(r.every(v=>v)){lines++;return false;}return true;});
 while(board.length<20) board.unshift(Array(10).fill(0));
 if(lines){
  score+=lines*100;
  if(score>=level*500){level++;dropSpeed=Math.max(5,dropSpeed-3);}
  document.getElementById("score").innerText=score;
  document.getElementById("level").innerText=level;
  sound(500);
 }
}

/* 회전 */
function rotate(){
 const r=piece.shape[0].map((_,i)=>piece.shape.map(r=>r[i]).reverse());
 const old=piece.shape;
 piece.shape=r;
 if(collide(piece)) piece.shape=old;
 else sound(800);
}

/* HOLD */
function holdPiece(){
 if(!canHold) return;
 sound(300);
 if(!hold){hold=piece; piece=next; next=newPiece();}
 else {[piece,hold]=[hold,piece]; piece.x=3; piece.y=0;}
 canHold=false;
}

/* 그리기 */
function grid(){
 ctx.strokeStyle="#fff";
 ctx.lineWidth = 1;
 for(let x=0;x<=10;x++){ctx.beginPath();ctx.moveTo(x*BLOCK,0);ctx.lineTo(x*BLOCK,canvas.height);ctx.stroke();}
 for(let y=0;y<=20;y++){ctx.beginPath();ctx.moveTo(0,y*BLOCK);ctx.lineTo(canvas.width,y*BLOCK);ctx.stroke();}
}
function drawBlock(c,x,y,color){c.fillStyle=color;c.fillRect(x*BLOCK,y*BLOCK,BLOCK,BLOCK);}
function drawMini(c,p){c.clearRect(0,0,120,120); if(!p) return; p.shape.forEach((r,y)=>r.forEach((v,x)=>v&&drawBlock(c,x,y,p.color)));}

/* Ghost piece */
function getGhost(){
 let ghost={...piece, shape:piece.shape.map(r=>[...r])};
 ghost.y = piece.y;
 while(!collide(ghost)) ghost.y++;
 ghost.y--;
 return ghost;
}
function drawGhost(){
 const ghost=getGhost();
 ghost.shape.forEach((r,y)=>r.forEach((v,x)=>v&&drawBlock(ctx, ghost.x+x, ghost.y+y, 'rgba(255,255,255,0.3)')));
 const leftX = piece.x*BLOCK;
 const rightX = (piece.x+piece.shape[0].length)*BLOCK;
 const topY = piece.y*BLOCK;
 const bottomY = ghost.y*BLOCK + ghost.shape.length*BLOCK;
 ctx.strokeStyle="#fff";
 ctx.lineWidth=2;
 ctx.beginPath();
 ctx.moveTo(leftX,topY); ctx.lineTo(leftX,bottomY); ctx.stroke();
 ctx.beginPath();
 ctx.moveTo(rightX,topY); ctx.lineTo(rightX,bottomY); ctx.stroke();
}

/* 전체 그리기 */
function draw(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 board.forEach((r,y)=>r.forEach((v,x)=>v&&drawBlock(ctx,x,y,v)));
 drawGhost();
 piece.shape.forEach((r,y)=>r.forEach((v,x)=>v&&drawBlock(ctx,piece.x+x,piece.y+y,piece.color)));
 grid();
 drawMini(holdC,hold);
 drawMini(nextC,next);
}

/* 루프 */
let count=0;
function update(){
 count++;
 if(count>dropSpeed){piece.y++; if(collide(piece)){piece.y--; merge();} count=0;}
 draw();
 requestAnimationFrame(update);
}

/* 키 입력 */
document.addEventListener("keydown",e=>{
 if(e.key==="ArrowLeft"){piece.x--;if(collide(piece))piece.x++;}
 if(e.key==="ArrowRight"){piece.x++;if(collide(piece))piece.x--;}
 if(e.key==="ArrowDown"){piece.y++;if(collide(piece))piece.y--;}
 if(e.key==="ArrowUp") rotate();
 if(e.key===" "){while(!collide(piece)) piece.y++; piece.y--; merge();}
 if(e.key==="e"||e.key==="E") holdPiece();
 if(e.key==="r"||e.key==="R") location.reload();
});

/* 터치 */
let startX, startY;
canvas.addEventListener('touchstart', e => { const touch=e.touches[0]; startX=touch.clientX; startY=touch.clientY; });
canvas.addEventListener('touchend', e => {
 if(!isMobile) return;
 const touch=e.changedTouches[0];
 const dx=touch.clientX-startX; const dy=touch.clientY-startY;
 if(Math.abs(dx)>Math.abs(dy)){
   if(dx>20){ piece.x++; if(collide(piece)) piece.x--; }
   else if(dx<-20){ piece.x--; if(collide(piece)) piece.x++; }
 } else {
   if(dy>20){ piece.y++; if(collide(piece)) piece.y--; }
   else if(dy<-20) rotate();
 }
});

/* 모바일 버튼 */
document.getElementById('holdBtnM')?.addEventListener('click', holdPiece);
document.getElementById('rotateBtnM')?.addEventListener('click', rotate);
document.getElementById('dropBtnM')?.addEventListener('click', ()=>{
 while(!collide(piece)) piece.y++; piece.y--; merge();
});
</script>
</body>
</html>
